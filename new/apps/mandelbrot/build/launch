#!/bin/bash

# This script starts the host application built for sw or hw.
# TODO: This is a big hack. The webserver should open the socket and start the host and tear down
#       the socket and host when it's done/killed.

# Usage:
#   launch hw
#   launch sw

if [[ "$1" = "" ]];
then
    echo "Usage: launch [sw/hw]"
    exit 1
fi


# Launch host app.
if [[ "$1" = "sw" ]];
then
    ../out/$1/host &
else
    sudo "source /opt/Xilinx/SDx/2017.1.rte.4ddr/setup.sh ; ../out/hw_emu/xilinx_aws-vu9p-f1_4ddr-xpr-2pr_4.0/host ../../mandelbrot/mandelbrot.awsxclbin mandelbrot" &
fi
HOST_PID=$!

python ../webserver/server.py &
SERVER_PID=$!

function finish {
    # Kill child processes
    kill $HOST_PID
    kill $SERVER_PID
    rm SOCKET
    echo "Killed host app and web server"
}

trap finish EXIT

wait

